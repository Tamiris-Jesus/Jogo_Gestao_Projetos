
// Declarando variáveis
let diryJ = 0, dirxJ = 0, jog, velJ = 5, pjx, pjy;
let velT;
let tamTelaW, tamTelaH;
let jogo;
let frames;
let contBombas, velB, tmpCriaBomba;
let bombasTotal;
let vidaPlaneta, barraPlaneta;
let ie = 0, isom = 0;
let telaMsg;

// Selecionando elementos HTML pela classe
const grid = document.querySelector('.grid');
const spanPlayer = document.querySelector('.player');
const timer = document.querySelector('.timer');

// Função auxiliar para criar elementos com classes
function createElement(tag, className) {
  const element = document.createElement(tag);
  element.className = className;
  return element;
}

let players = []; // Lista de jogadores

// Função para exibir a tabela de classificação dos jogadores
function showRanking() {
  // Cria os elementos da tabela
  const table = createElement('table', 'ranking-table');
  const thead = createElement('thead', 'ranking-head');
  const tbody = createElement('tbody', 'ranking-body');

  // Cabeçalho da tabela
  const thRank = createElement('th', 'ranking-header');
  const thName = createElement('th', 'ranking-header');
  const thTime = createElement('th', 'ranking-header');
  thRank.textContent = '#'; // Texto do cabeçalho do ranking
  thName.textContent = 'Nome'; // Texto do cabeçalho do nome do jogador
  thTime.textContent = 'Tempo (segundos)'; // Texto do cabeçalho do tempo do jogador
  thead.appendChild(thRank);
  thead.appendChild(thName);
  thead.appendChild(thTime);
  table.appendChild(thead);

  // Linhas da tabela com os jogadores classificados
  players.sort((a, b) => a.time - b.time); // Classifica os jogadores pelo tempo
  players.forEach((player, index) => {
    const tr = createElement('tr', 'ranking-row'); // Linha da tabela
    const tdRank = createElement('td', 'ranking-data'); // Coluna para o número da posição do jogador
    const tdName = createElement('td', 'ranking-data'); // Coluna para o nome do jogador
    const tdTime = createElement('td', 'ranking-data'); // Coluna para o tempo do jogador
    tdRank.textContent = index + 1; // Número da posição do jogador (inicia em 1)
    tdName.textContent = player.name; // Nome do jogador
    tdTime.textContent = player.time; // Tempo do jogador
    tr.appendChild(tdRank);
    tr.appendChild(tdName);
    tr.appendChild(tdTime);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  // Adiciona a tabela de classificação ao elemento HTML com a classe "ranking"
  const ranking = document.querySelector('.ranking');
  ranking.innerHTML = ''; // Limpa o conteúdo atual do ranking
  ranking.appendChild(table);
}

// // Função para exibir o menu de fim de jogo
// function endGameMenu() {
//   const container = document.querySelector('.container');
//   container.style.display = 'flex'; // Exibe o container do jogo

//   const restartBtn = document.querySelector('.restart-btn');
//   const homeBtn = document.querySelector('.home-btn');

//   // restartBtn.addEventListener('click', restartGame); // Adiciona ouvinte de evento para o botão de reiniciar
//   homeBtn.addEventListener('click', goToHomePage); // Adiciona ouvinte de evento para o botão de voltar para a página inicial


//   const playerName = spanPlayer.innerHTML;
//   const playerTime = timer.innerHTML;
//   players.push({ name: playerName, time: playerTime }); // Adiciona o jogador atual à lista de jogadores

//   localStorage.setItem('players', JSON.stringify(players)); // Armazena a lista de jogadores no localStorage
//   showRanking(); // Exibe a tabela de classificação dos jogadores
// }


// Função para exibir o menu de fim de jogo
function endGameMenu() {
  const container = document.querySelector('.container');
  container.style.display = 'flex'; // Exibe o container do jogo

  const restartBtn = document.querySelector('.restart-btn');
  const homeBtn = document.querySelector('.home-btn');

  // restartBtn.addEventListener('click', restartGame); // Adiciona ouvinte de evento para o botão de reiniciar
  homeBtn.addEventListener('click', goToHomePage); // Adiciona ouvinte de evento para o botão de voltar para a página inicial

   // Armazena o tempo e nome do jogador no localStorage
  localStorage.setItem('playerTime', playerTime);
  localStorage.setItem('playerName', playerName);


  const playerName = spanPlayer.innerHTML;
  const playerTime = timer.innerHTML;
  players.push({ name: playerName, time: playerTime }); // Adiciona o jogador atual à lista de jogadores
  localStorage.setItem('players', JSON.stringify(players)); // Armazena a lista de jogadores no localStorage

  showRanking(); // Exibe a tabela de classificação dos jogadores

 
}




// Função para iniciar o temporizador
function startTimer() {
  setInterval(() => {
    const currentTime = parseInt(timer.innerHTML);
    timer.innerHTML = currentTime + 1;
  }, 1000); // Atualiza o temporizador a cada 1 segundo
}

// Função para voltar para a página inicial
const goToHomePage = () => {
  clearInterval(this.loop); // Limpa o intervalo do temporizador
  window.location.href = '../index.html'; // Redireciona o navegador para a página inicial
};

function init() {
  // startTimer(); // Inicie o temporizador

  jogo = true; // Altere para true para iniciar o jogo imediatamente

  tamTelaH = window.innerHeight;
  tamTelaW = window.innerWidth;

  dirxJ = diryJ = 0;
  pjx = tamTelaW / 2;
  pjy = tamTelaH / 2;
  velJ = velT = 5;
  jog = document.getElementById("naveJog");
  jog.style.top = pjy + "px";
  jog.style.left = pjx + "px";

  contBombas = 150;
  velB = 3;

  vidaPlaneta = 100;
  barraPlaneta = document.getElementById("barraPlaneta");
  barraPlaneta.style.width = vidaPlaneta + "px";

  ie = ison = 0;

  telaMsg = document.getElementById("telaMsg");
  telaMsg.style.display = "none"; // Oculte a tela de mensagem inicial

  window.addEventListener("keydown", teclaDw);
  window.addEventListener("keyup", teclaUp);

  tmpCriaBomba = setInterval(criaBomba, 1700);
  gameLoop(); // Inicie o loop do jogo imediatamente
}

function teclaDw(event) {
  var tecla = event.keyCode;
  if (tecla == 38) { // Cima
    diryJ = -1;
  } else if (tecla == 40) { // Baixo
    diryJ = 1;
  }
  if (tecla == 37) { // Esquerda
    dirxJ = -1;
  } else if (tecla == 39) { // Direita
    dirxJ = 1;
  }
  if (tecla == 32) { // Espaço / Tiro
    atira(pjx + 17, pjy);
  }
}

function teclaUp(event) {
  var tecla = event.keyCode;
  if ((tecla == 38) || (tecla == 40)) {
    diryJ = 0;
  }
  if ((tecla == 37) || (tecla == 39)) { // Esquerda
    dirxJ = 0;
  }
}

function criaBomba() {
  if (jogo) {
    var y = 0;
    var x = Math.random() * tamTelaW;
    var bomba = document.createElement("div");
    bomba.className = "bomba";
    bomba.style.top = y + "px";
    bomba.style.left = x + "px";
    document.body.appendChild(bomba);
    contBombas--;
  }
}

function controlaBomba() {
  bombasTotal = document.getElementsByClassName("bomba");
  var tam = bombasTotal.length;
  for (var i = 0; i < tam; i++) {
    if (bombasTotal[i]) {
      var pi = bombasTotal[i].offsetTop;
      pi += velB;
      bombasTotal[i].style.top = pi + "px";
      if (pi > tamTelaH) {
        vidaPlaneta -= 10;
        criaExplosao(2, bombasTotal[i].offsetLeft, null);
        bombasTotal[i].remove();
      }
    }
  }
}

function atira(x, y) {
  var t = document.createElement("div");
  t.className = "tiroJog";
  t.style.top = y + "px";
  t.style.left = x + "px";
  document.body.appendChild(t);
}

function controleTiros() {
  var tiros = document.getElementsByClassName("tiroJog");
  var tam = tiros.length;
  for (var i = 0; i < tam; i++) {
    if (tiros[i]) {
      var pt = tiros[i].offsetTop;
      pt -= velT;
      tiros[i].style.top = pt + "px";
      colisaoTiroBomba(tiros[i]);
      if (pt < 0) {
        tiros[i].remove();
      }
    }
  }
}

function colisaoTiroBomba(tiro) {
  var tam = bombasTotal.length;
  for (var i = 0; i < tam; i++) {
    if (bombasTotal[i]) {
      if (
        (tiro.offsetTop <= (bombasTotal[i].offsetTop + 40)) &&
        ((tiro.offsetTop + 6) >= (bombasTotal[i].offsetTop)) &&
        (tiro.offsetLeft <= (bombasTotal[i].offsetLeft + 24)) &&
        ((tiro.offsetLeft + 6) >= (bombasTotal[i].offsetLeft))
      ) {
        criaExplosao(1, bombasTotal[i].offsetLeft - 25, bombasTotal[i].offsetTop);
        bombasTotal[i].remove();
        tiro.remove();
      }
    }
  }
}

function criaExplosao(tipo, x, y) {
  if (document.getElementById("explosao" + (ie - 4))) {
    document.getElementById("explosao" + (ie - 4)).remove();
  }
  var explosao = document.createElement("div");
  var img = document.createElement("img");
  var som = document.createElement("audio");
  explosao.id = "explosao" + ie;
  if (tipo == 1) {
    explosao.className = "explosaoAr";
    explosao.style.top = y + "px";
    explosao.style.left = x + "px";
    img.src = "../assets/explosao_ar.gif?" + new Date();
  } else {
    explosao.className = "explosaoChao";
    explosao.style.top = (tamTelaH - 57) + "px";
    explosao.style.left = (x - 17) + "px";
    img.src = "../assets/explosao_chao.gif?" + new Date();
  }
  som.src = "../assets/exp1.mp3?" + new Date();
  som.id = "som" + isom;
  explosao.appendChild(img);
  explosao.appendChild(som);
  document.body.appendChild(explosao);
  document.getElementById("som" + isom).play();
  ie++;
  isom++;
}

function controlaJogador() {
  pjy += diryJ * velJ;
  pjx += dirxJ * velJ;
  jog.style.top = pjy + "px";
  jog.style.left = pjx + "px";
}

function gerenciaGame() {
  barraPlaneta.style.width = vidaPlaneta + "px";
  if (vidaPlaneta <= 0) {
    jogo = false;
    clearInterval(tmpCriaBomba);
    // telaMsg.style.backgroundImage = "url('../assets/derrota.jpg')";
    telaMsg.style.display = "block";
    endGameMenu(); // Chame endGameMenu() quando o jogador vencer
    
  }
}

function gameLoop() {
  if (jogo) {
    controlaJogador();
    controleTiros();
    controlaBomba();
  }
  gerenciaGame();
  frames = requestAnimationFrame(gameLoop);
}

function reinicia() {
  bombasTotal = document.getElementsByClassName("bomba");
  var tam = bombasTotal.length;
  for (var i = 0; i < tam; i++) {
    if (bombasTotal[i]) {
      bombasTotal[i].remove();
    }
  }
  telaMsg.style.display = "none";
  clearInterval(tmpCriaBomba);
  cancelAnimationFrame(frames);
  vidaPlaneta = 300;
  pjx = tamTelaW / 2;
  pjy = tamTelaH / 2;
  jog.style.top = pjy + "px";
  jog.style.left = pjx + "px";
  contBombas = 150;
  jogo = true;
  tmpCriaBomba = setInterval(criaBomba, 1700);
  gameLoop();
}


window.onload = () => {
  const container = document.querySelector('.container');
  container.style.display = 'none'; // Esconde o container do jogo

  const storedPlayers = JSON.parse(localStorage.getItem('players'));
  if (storedPlayers) {
    players = storedPlayers; // Carrega a lista de jogadores do localStorage, se existir
  }

  spanPlayer.innerHTML = localStorage.getItem('player'); // Obtém o nome do jogador do localStorage e exibe no elemento HTML
  
  startTimer(); // Inicie o temporizador

  init();
};

